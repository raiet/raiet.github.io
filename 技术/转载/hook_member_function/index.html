<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>linux中hook成员函数 | 诗和远方</title>
    <meta name="author" content="raiet">
    
    <meta name="description" content="这里是描述">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="linux中hook成员函数"/>
    <meta property="og:site_name" content="手插口袋的少年&#39;s Blog"/>

    
    <meta property="og:image" content=""/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="手插口袋的少年&#39;s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo lighten-1">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">手插口袋的少年&#39;s Blog</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="https://public-1251809323.cos.ap-guangzhou.myqcloud.com/git/small_avatar.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">手插口袋的少年</p>
                        <p class="desc">懒虫什么也没留下</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/技术/">
                    技术 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/技术/转载/">
                    转载 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/工具/">
                    工具 <span class="right">1 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo lighten-2">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/技术/">技术</a><a class="breadcrumb" href="/categories/技术/转载/">转载</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>linux中hook成员函数</h1>
    


            </div>
            <time class="green-link-context" datetime="2018-04-10T11:11:37.000Z"><a href="/技术/转载/hook_member_function/">2018-04-10</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/hook/" class="chip green">hook</a>
        
            <a href="/tags/linux/" class="chip green">linux</a>
        
    </div>


            <div class="toc green-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#Teleport"><span class="section table-of-contents-text">Teleport</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#Move-faster-Jump-higher"><span class="section table-of-contents-text">Move faster, Jump higher</span></a></li></ol>
</div>


            <div class="entry green-link-context">
                <p>hook机制，无限强大，似乎是只有你想不到，没有他做不到的。之前一直有同学秀技术，可以破解某些需要注册的软件，觉得非常屌，看了这篇文章，似乎分分钟自己也能掳一个xx软件的破解版<br><a id="more"></a></p>
<p>原文地址：<a href="https://blog.keyidentity.com/2017/07/25/pwnadventure3-hooking-shared-library" target="_blank" rel="noopener">https://blog.keyidentity.com/2017/07/25/pwnadventure3-hooking-shared-library/</a></p>
<p>With our blog post about binary patching, we saw how to edit the client binary to modify a function in our advantage. The change was minor, i.e. a single line in assembly. If we want to modify the function to add more complex logic and thus more assembly code, we will need to use code cave in order to avoid overwriting essential instructions for the game to execute properly.</p>
<p>The code cave technique consist of finding an area in the binary that is not used and add our assembly instruction in it. Then, in the function we want to modify, we overwrite one instruction to jump in our code cave. Our code cave should save the registers and flags and restored them at the end of it, as well as re-aligning the stack. Finally, we should also add in our code cave the overwritten instruction (used for the the jump) and jump back in the initial function.</p>
<p>This procedure is often used by malware developer to hide malicious code into benign applications. The problem with this solution is that it is easy the break the application, and also, it requires you to write your changes in assembly.</p>
<p>An easier solution would be to hook the library used by the client in order to “hijack” the execution flow and run custom code. With this solution, you write a new library in C/C++ and use LD_PRELOAD (in Linux) to load your new library before all others. This post will give you an example of how to use LD_PRELOAD in order to modify the logic of the game and be able to teleport wherever you want at any time and change your movement speed and jump height on the fly.</p>
<p>Like with our packet injection proxy, we want to decide when to activate the hack. Therefore, we will hook the chat function so that whenever we send a specific string in the chat, it activates the appropriate “hack”. Chat is a great target since we can trigger it whenever we want, and send custom strings, which allow us a activate a wide range hack.</p>
<p>In this example, I will use Hopper to identify the chat function.</p>
<p>The function to hook is <code>Player::Chat()</code>. So in our new library, we will write the following code (hook.cc):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// #define _GNU_SOURCE</span><br><span class="line"></span><br><span class="line">#include &lt;dlfcn.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">class Player &#123;</span><br><span class="line"> </span><br><span class="line">    public:</span><br><span class="line">        void Chat(const char *text);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">typedef void (*orig_chat_f_type)(Player *, const char *);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void Player::Chat(const char *text)</span><br><span class="line">&#123;</span><br><span class="line">    std::string str(text);</span><br><span class="line">    std::cout &lt;&lt; &quot;Chat: &quot; &lt;&lt; str &lt;&lt; &quot;\n&quot;;</span><br><span class="line"></span><br><span class="line">    // Call orignal Player::Chat() function</span><br><span class="line">    orig_chat_f_type orig;</span><br><span class="line">    orig = (orig_chat_f_type) dlsym(RTLD_NEXT, &quot;_ZN6Player4ChatEPKc&quot;);</span><br><span class="line">    orig(this, text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In this example, we want to make sure that we hooked the right function. Therefore, we simply outputted the content of the chat for debug purposes. Since <code>Player::chat</code> is a member function of a class, we first need to define the class itself (i.e. Player) and declare the new function chat within. Once the function declared, we simply defined it. Thanks to the debug information from the libGameLogic.so, we know that the function name as well at the arguments and return types (i.e. it takes as argument one pointer to a Player object and one pointer to a char array, and return void).</p>
<p>We want the function chat to still operate as initially, so we want to re-route the execution flow back to the original Chat function. For this, we use dlsym to find the original Chat function address in the shared libraries and call it from the new Chat function. For this, we first need to define the variable that will receive the pointer to the original chat function. Then we use the mangled name to find the function with dlsym. Finally, we forward the parameters when calling the function.</p>
<p>Once the new C++ code written, we can compile our new shared library:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -shared -fPIC -o hook.so hook.cc</span><br></pre></td></tr></table></figure></p>
<p>Once done, we need to run the client with LD_PRELOAD so that we can load our new library before libGameLogic.so.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LD_PRELOAD=`pwd`/hook.so ./PwnAdventure3-Linux-Shipping</span><br></pre></td></tr></table></figure></p>
<p>The binary <code>PwnAdventure3-Linux-Shipping</code> is the actual executable for the game. The binary is located here:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PwnAdventure3_data/PwnAdventure3/PwnAdventure3/Binaries/Linux/PwnAdventure3-Linux-Shipping</span><br></pre></td></tr></table></figure></p>
<p>Now, we just need to join the game with any character and type anything in the chat dialog box (press enter) and you should see the text in the console where you executed the client.</p>
<h1 id="Teleport"><a href="#Teleport" class="headerlink" title="Teleport"></a>Teleport</h1><p>Now the we have successfully hijacked the chat function, we want to hack the game. For instance, teleporting wherever we want. We could develop a new function that will take care of changing our X, Y, Z position and update the server with our new location, but let’s check first if there is no function already available for that.</p>
<p>After spending some time looking for specific functions that contains words related to teleporting, I ended up with a very interesting function: <code>Player::PerformTeleport</code>. We can see in that function at an offset of 0x15843A a call to Actor::SetPosition(Vector3 const&amp;). This function take as argument a Vector3 variable (an array of 3 floats) that contains the coordinate to set the new position of an Actor (including our player).</p>
<p>Let’s try to call that function with arbitrary coordinate. Vector3 is a variable that contains 3 floats, for the 3 coordinate X, Y and Z:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct Vector3 &#123; float x; float y; float z; &#125;;</span><br></pre></td></tr></table></figure></p>
<p>Let’s take a position close to Michael Angelo for instance:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vector3 pos;</span><br><span class="line">pos.x = 260255.0;</span><br><span class="line">pos.y = -249336.0;</span><br><span class="line">pos.z = 1476.0;</span><br></pre></td></tr></table></figure></p>
<p>We will then use again dlsym to find the address of the function original function in the library:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typedef void (*orig_pos_f_type)(Player *, const Vector3 *);</span><br><span class="line">orig_pos_f_type orig;</span><br><span class="line">orig = (orig_pos_f_type) dlsym(RTLD_NEXT, &quot;_ZN5Actor11SetPositionERK7Vector3&quot;);</span><br></pre></td></tr></table></figure></p>
<p>Same as we’ve done before, we want to execute the function <code>Actor::SetPosition()</code> whenever we send a specific string in the chat, e.g. “Michael”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void Player::Chat(const char *text)</span><br><span class="line">&#123;</span><br><span class="line">    std::string str(text);</span><br><span class="line"></span><br><span class="line">    if (str.compare(&quot;Michael&quot;) == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        orig(this, &amp;p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Call orignal Player::Chat() function</span><br><span class="line">    orig_chat_f_type orig;</span><br><span class="line">    orig = (orig_chat_f_type) dlsym(RTLD_NEXT, &quot;_ZN6Player4ChatEPKc&quot;);</span><br><span class="line">    orig(this, text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Once, again, you compile then you run the client with DL_PRELOAD and when in the game, type “Michael” and you should be teleported to Michael Angelo.</p>
<h1 id="Move-faster-Jump-higher"><a href="#Move-faster-Jump-higher" class="headerlink" title="Move faster, Jump higher"></a>Move faster, Jump higher</h1><p>For this final exercise, we will change the capacity of our character to move faster on the fly. Instead of always editing the binary and restart the game, we will hook the library so that whenever we send a particular string in the chat, it will modify our movement speed.</p>
<p>In our previous blog post, we edited the sprint multiplier, however, here we want to change the default walking speed. For the, I simply search for “getspeed” in Hopper.</p>
<p>The function Player::GetWalkingSpeed() belongs to the class Player and returns a local variable of the instantiated object that calls the function. It’s a typical accessor method.</p>
<p>Unfortunately, I cannot simply get the value of a variable based on its name. The only thing I know is that the value for the walking speed is located at an offset of 736 (integer) bytes. Between that variable and the beginning of the objects are other variables and pointers, which would take too much time to entirely reverse. But there is no need to, the offset is sufficient. In our hook, we will simply edit the value located at this specific offset. For this, I will use an array as a “padding”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Player &#123;</span><br><span class="line"></span><br><span class="line">    public:</span><br><span class="line">        char padding[736];</span><br><span class="line">        float speed;</span><br><span class="line">        void Chat(const char *text);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void Player::Chat(const char *text)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    std::string str(text);</span><br><span class="line"></span><br><span class="line">    if (str.compare(&quot;speed up&quot;) == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        this-&gt;jumpspeed = this-&gt;jumpspeed * 1.5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Call orignal Player::Chat() function</span><br><span class="line">    orig_chat_f_type orig;</span><br><span class="line">    orig = (orig_chat_f_type) dlsym(RTLD_NEXT, &quot;_ZN6Player4ChatEPKc&quot;);</span><br><span class="line">    orig(this, text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can see in Hopper that the jump speed and the jump hold time is located at an offset of 740 (int) and 744 (int) bytes, thus right after the walking speed. We then simply need to add the two additional variables:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class Player &#123;</span><br><span class="line"></span><br><span class="line">    public:</span><br><span class="line">        char padding[736];</span><br><span class="line">        float speed;</span><br><span class="line">        float jumpspeed;</span><br><span class="line">        float jumphold;</span><br><span class="line">        void Chat(const char *text);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>And later access and modify them with:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">this-&gt;jumpspeed </span><br><span class="line">this-&gt;jumphold</span><br></pre></td></tr></table></figure></p>
<p>You can find the final <a href="https://github.com/Foxmole/PwnAdventure3/blob/master/hook.cc" target="_blank" rel="noopener">hook.cc</a> code in our <a href="https://github.com/Foxmole/PwnAdventure3" target="_blank" rel="noopener">GitHub page</a>.</p>

                
<p class="green-link-context">
    <a href="/uncategorized/test/" rel="next" title="test">
    上一篇：test
  </a>
</p>



<p class="green-link-context">
    <a href="/工具/svn_externals/" rel="next" title="在svn中使用文件/目录链接">
    下一篇：在svn中使用文件/目录链接
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>




    <section id="comment">
        <div id="disqus_thread"></div>
        <script>
            var disqus_config = function() {
                this.page.url = 'http://raiet.github.io/技术/转载/hook_member_function/';
                this.page.identifier = '技术/转载/hook_member_function/';
            };
            (function() {
                var d = document,
                    s = d.createElement('script');
                s.src = '//github-raiet.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
        </noscript>
    </section>



</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo lighten-2 darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/raiet" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/raiet" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span>
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://raytaylorlin.com/" target="_blank">raytaylorism主题作者的技术博客</a>
                
                    <a class="social-link" href="https://github.com/raiet" target="_blank">Github地址</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright green-link-context">
        <div class="container">
            © 2018 example.com, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about-notexist').append('<span class="new badge deep-orange lighten-3"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>








</body>
</html>
